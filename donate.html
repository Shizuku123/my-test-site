<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        .slide-up {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.5s cubic-bezier(.4,0,.2,1), transform 0.5s cubic-bezier(.4,0,.2,1);
        }
        .slide-up.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .fade-in {
            opacity: 0;
            transition: opacity 0.6s cubic-bezier(.4,0,.2,1);
        }
        .fade-in.visible {
            opacity: 1;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate to Tahanan ng Pagmamahal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-red': '#dc2626',
                        'brand-orange': '#ea580c'
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <script type="module">

import { auth, db } from './firebase-donor.js';
import { doc, updateDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

let authStateLoaded = false;

document.addEventListener('DOMContentLoaded', () => {
    auth.onAuthStateChanged(async (user) => {
        const loginSection = document.getElementById('loginSection');
        const userWelcomeSection = document.getElementById('userWelcomeSection');
        const userName = document.getElementById('userName');
        const mobileUserSection = document.getElementById('mobileUserSection');
        const mobileUserName = document.getElementById('mobileUserName');
        const donationHistoryLink = document.getElementById('donationHistoryLink');
        const logoutLink = document.getElementById('logoutLink');

        if (!authStateLoaded) {
            await new Promise(resolve => setTimeout(resolve, 800)); // 800ms delay
            authStateLoaded = true;
        }

        if (user && user.emailVerified) {
            // Get user profile
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                const userData = userDoc.data();
                // Update visit tracking
                await updateDoc(userRef, {
                    lastVisit: new Date().toISOString(),
                    visitCount: increment(1)
                });
                // Show user welcome section with animation
                if (userData.firstName) {
                    if (userName) userName.textContent = userData.firstName;
                    if (mobileUserName) mobileUserName.textContent = userData.firstName;
                    if (mobileUserSection) mobileUserSection.classList.remove('hidden');
                    if (loginSection) loginSection.classList.add('hidden');
                    if (userWelcomeSection) {
                        userWelcomeSection.classList.remove('hidden');
                        setTimeout(() => {
                            userWelcomeSection.classList.add('visible');
                        }, 200);
                    }
                    // Show donation history and log out links
                    if (donationHistoryLink) donationHistoryLink.classList.remove('hidden');
                    if (logoutLink) logoutLink.classList.remove('hidden');
                }
            }
        } else {
            if (loginSection) {
                loginSection.classList.remove('auth-loading');
                loginSection.classList.remove('hidden');
            }
            if (userWelcomeSection) {
                userWelcomeSection.classList.add('hidden');
                userWelcomeSection.classList.remove('visible');
            }
            if (mobileUserSection) mobileUserSection.classList.add('hidden');
            // Hide donation history and log out links
            if (donationHistoryLink) donationHistoryLink.classList.add('hidden');
            if (logoutLink) logoutLink.classList.add('hidden');
        }
    });
});

window.handleLogout = function() {
    const showLogoutAlert = (message, isError = false) => {
        const alertDiv = document.createElement('div');
        alertDiv.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-sm bg-${isError ? 'red' : 'green'}-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 transition-all duration-300 opacity-0 translate-y-8`;
        alertDiv.innerHTML = `<i class="fas fa-${isError ? 'exclamation-circle' : 'check-circle'} mr-2"></i>${message}`;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.classList.remove('opacity-0', 'translate-y-8');
            alertDiv.classList.add('opacity-100', 'translate-y-0');
        }, 100);

        setTimeout(() => {
            alertDiv.classList.remove('opacity-100', 'translate-y-0');
            alertDiv.classList.add('opacity-0', 'translate-y-8');
            setTimeout(() => {
            alertDiv.remove();
            }, 300);
        }, 2000);
        };

        const confirmDiv = document.createElement('div');
        confirmDiv.className = "fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-md bg-white text-gray-900 px-6 py-6 rounded-lg shadow-lg z-50 transition-all duration-300 opacity-0 translate-y-8 flex flex-col items-center";
    confirmDiv.innerHTML = `
        <span class="mb-2"><i class="fas fa-sign-out-alt mr-2 text-brand-red"></i>Are you sure you want to log out?</span>
        <div class="flex gap-4">
            <button id="confirmLogoutBtn" class="bg-brand-red hover:bg-brand-orange text-white px-4 py-2 rounded">Log out</button>
            <button id="cancelLogoutBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-900 px-4 py-2 rounded">Cancel</button>
        </div>
    `;
    document.body.appendChild(confirmDiv);

    setTimeout(() => {
        confirmDiv.classList.remove('opacity-0', 'translate-y-8');
        confirmDiv.classList.add('opacity-100', 'translate-y-0');
    }, 100);

    document.getElementById('confirmLogoutBtn').onclick = function() {
        signOut(auth).then(() => {
            confirmDiv.remove();
            showLogoutAlert('Successfully logged out!');
            setTimeout(() => {
                window.location.reload();
            }, 2200);
        }).catch((error) => {
            confirmDiv.remove();
            showLogoutAlert('Error logging out. Please try again.', true);
        });
    };
    document.getElementById('cancelLogoutBtn').onclick = function() {
        confirmDiv.classList.remove('opacity-100', 'translate-y-0');
        confirmDiv.classList.add('opacity-0', 'translate-y-8');
        setTimeout(() => {
            confirmDiv.remove();
        }, 300);
    };
};
</script>
</head>
<a href="index.html" class="absolute top-6 left-6 flex items-center text-gray-400 hover:text-brand-red transition-colors text-sm font-medium z-10">
    <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
    </svg>
    Back
</a>
<body class="font-poppins bg-gray-50 min-h-screen flex items-center justify-center">
    <!-- To set a custom width, adjust the 'style' value below (e.g., width: 380px). Responsive padding and max-width remain for mobile. -->
    <div class="w-full max-w-xs bg-white rounded-2xl shadow-lg border border-gray-100 p-8 px-8 sm:px-12 relative mt-10 fade-in" style="width: 450px;" id="mainFadeIn">
        
        
        <div id="copyFeedback" class="text-green-600 text-xs font-medium mb-2 text-right pr-2" style="display:none;">Link copied!</div>
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-brand-red rounded-full flex items-center justify-center mx-auto mb-4 animate-slideUp" id="donateIcon">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1M10 17L6 13L7.41 11.59L10 14.17L16.59 7.58L18 9L10 17Z"/>
                </svg>
            </div>
            <h1 class="text-2xl font-semibold text-gray-900 mb-2 slide-up" id="donateHeading">Donate to the Orphanage</h1>
            <p class="text-gray-600 text-sm slide-up" id="donateDesc">Your generosity makes a difference!</p>
        </div>
        <form id="donateForm" class="space-y-6">
            <div class="slide-up" id="fieldName">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name <span class="text-gray-400">(optional)</span></label>
                <input type="text" id="name" name="name" class="w-full border border-gray-200 rounded-lg px-4 py-2 focus:border-brand-red focus:ring-1 focus:ring-brand-red focus:outline-none transition-colors" placeholder="Your Name">
            </div>
            <div class="slide-up" id="fieldEmail">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-gray-400">(optional)</span></label>
                <input type="email" id="email" name="email" class="w-full border border-gray-200 rounded-lg px-4 py-2 focus:border-brand-red focus:ring-1 focus:ring-brand-red focus:outline-none transition-colors" placeholder="you@email.com">
            </div>
            <div class="slide-up" id="fieldAmount">
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount <span class="text-brand-red">*</span></label>
                <input type="number" id="amount" name="amount" min="1" step="0.01" required class="w-full border border-gray-200 rounded-lg px-4 py-2 focus:border-brand-red focus:ring-1 focus:ring-brand-red focus:outline-none transition-colors" placeholder="Enter amount (PHP)">
            </div>
            <div class="slide-up" id="fieldMessage">
                <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Message <span class="text-gray-400">(optional)</span></label>
                <textarea id="message" name="message" rows="2" class="w-full border border-gray-200 rounded-lg px-4 py-2 focus:border-brand-red focus:ring-1 focus:ring-brand-red focus:outline-none transition-colors" placeholder="Your message..."></textarea>
            </div>
            <button type="submit" class="w-full bg-brand-red hover:bg-brand-orange text-white py-3 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-brand-red focus:ring-offset-2 slide-up" id="fieldButton">Donate Now</button>
        </form>
        <!-- Confirmation Modal -->
        <div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white/95 rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center relative animate-fadeIn modal-content" style="backdrop-filter: blur(2px); width: 340px;">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4">Confirm Your Donation</h2>
                <p class="text-base md:text-lg text-gray-700 mb-2">Please review your information before proceeding.</p>
                <div id="confirmAmount" class="text-lg font-semibold text-brand-red mb-4"></div>
                <p class="text-sm md:text-base text-gray-600 mb-6"><strong class="text-brand-red">All donations are final and non-refundable.</strong></p>
                <div class="flex flex-col sm:flex-row justify-center gap-3 mt-2">
                    <button id="confirmYesBtn" class="confirm-btn focus:outline-brand-red focus:ring-2 focus:ring-brand-red focus:ring-offset-2 transition-colors">Confirm Donation</button>
                    <button id="confirmNoBtn" class="cancel-btn focus:outline-gray-400 focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors">Cancel</button>
                </div>
            </div>
        </div>
        <!-- Success Message -->
        <div id="successMessage" class="bg-green-50 border border-green-200 rounded-2xl p-6 text-center hidden mt-6">
            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-green-800 mb-2">Thank you for your donation!</h3>
            <p class="text-green-600 text-sm mb-4">Your support means a lot to us and the children.</p>
        </div>
        <!-- Share Notification Bar (hidden initially, slides down after success) -->
        <!-- Share Notification Bar (hidden initially, slides down from top after success) -->
        <div class="fixed left-0 right-0 top-0 z-40 flex items-center justify-between bg-orange-50 border-b border-orange-200 rounded-b-xl px-4 py-3 slide-down"
            id="shareBar"
            style="display:none; opacity:0; transform: translateY(-64px); transition: opacity 0.4s cubic-bezier(.4,0,.2,1), transform 0.4s cubic-bezier(.4,0,.2,1);">
            <a href="index.html" class="flex items-center text-gray-400 hover:text-brand-red transition-colors text-sm font-medium mr-4">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
            Back
            </a>
            <div class="flex-1 flex items-center justify-center">
            <span class="text-brand-orange font-medium text-sm">Share with your friends</span>
            </div>
            <button id="copyLinkBtn" class="bg-brand-orange hover:bg-brand-red text-white px-3 py-1.5 rounded-lg text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2 ml-4">Copy Link</button>
        </div>
        <script>
            // Slide-down animation for share bar after donation confirmation
            document.addEventListener('DOMContentLoaded', function() {
               var shareBar = document.getElementById('shareBar');
               var confirmYesBtn = document.getElementById('confirmYesBtn');
               if (confirmYesBtn && shareBar) {
              confirmYesBtn.addEventListener('click', function() {
                 shareBar.style.display = 'flex';
                 shareBar.style.opacity = '0';
                 shareBar.style.transform = 'translateY(-64px)';
                 setTimeout(function() {
                shareBar.style.opacity = '1';
                shareBar.style.transform = 'translateY(0)';
                 }, 80);
              });
               }
            });
        </script>
    </div>
    <script>
        // Fade-in and slide-up animation logic for main container, heading, description, and fields
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                document.getElementById('mainFadeIn').classList.add('visible');
            }, 50);
            setTimeout(function() {
                document.getElementById('donateHeading').classList.add('visible');
            }, 150);
            setTimeout(function() {
                document.getElementById('donateDesc').classList.add('visible');
            }, 350);
            setTimeout(function() {
                document.getElementById('fieldName').classList.add('visible');
            }, 450);
            setTimeout(function() {
                document.getElementById('fieldEmail').classList.add('visible');
            }, 550);
            setTimeout(function() {
                document.getElementById('fieldAmount').classList.add('visible');
            }, 650);
            setTimeout(function() {
                document.getElementById('fieldMessage').classList.add('visible');
            }, 750);
            setTimeout(function() {
                document.getElementById('fieldButton').classList.add('visible');
            }, 850);
        });

        // Copy Link button logic
        document.addEventListener('DOMContentLoaded', function() {
            var copyBtn = document.getElementById('copyLinkBtn');
            var feedback = document.getElementById('copyFeedback');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    navigator.clipboard.writeText(window.location.href).then(function() {
                        feedback.style.display = 'block';
                        setTimeout(function() { feedback.style.display = 'none'; }, 1800);
                    });
                });
            }
        });
        // Modal logic
        const donateForm = document.getElementById('donateForm');
        const confirmModal = document.getElementById('confirmModal');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        const successMessage = document.getElementById('successMessage');
        const confirmAmount = document.getElementById('confirmAmount');
        let formData = null;

        // Animate modal entrance
        if (!document.getElementById('fadeInStyle')) {
            const style = document.createElement('style');
            style.id = 'fadeInStyle';
            style.innerHTML = `
                @keyframes fadeIn { from { opacity: 0; transform: translateY(32px);} to { opacity: 1; transform: none; } }
                .animate-fadeIn { animation: fadeIn 0.18s cubic-bezier(.4,0,.2,1); }
                .confirm-btn {
                    background-color: #dc2626;
                    color: #fff;
                    border-radius: 8px;
                    padding: 0.75rem 1.5rem;
                    font-weight: 600;
                    font-size: 1rem;
                    outline: none;
                    border: none;
                }
                .confirm-btn:focus { box-shadow: 0 0 0 2px #dc262633; }
                .confirm-btn:hover { background-color: #ea580c; }
                .cancel-btn {
                    background-color: #f0f0f0;
                    color: #333;
                    border-radius: 8px;
                    padding: 0.75rem 1.5rem;
                    font-weight: 600;
                    font-size: 1rem;
                    outline: none;
                    border: 1px solid #d1d5db;
                }
                .cancel-btn:focus { box-shadow: 0 0 0 2px #d1d5db66; }
                @media (max-width: 640px) {
                    .modal-content { padding: 1.25rem !important; }
                    .confirm-btn, .cancel-btn { font-size: 0.95rem; padding: 0.6rem 1.1rem; }
                }
            `;
            document.head.appendChild(style);
        }

        donateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            // Validate amount
            const amount = document.getElementById('amount').value;
            if (!amount || parseFloat(amount) <= 0) {
                document.getElementById('amount').focus();
                return;
            }
            // Store form data
            formData = new FormData(donateForm);
            // Show formatted amount in modal
            confirmAmount.textContent = 'Amount: ₱' + parseFloat(amount).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            confirmModal.classList.remove('hidden');
            // Focus confirm button for accessibility
            setTimeout(() => { confirmYesBtn.focus(); }, 120);
        });
        confirmYesBtn.addEventListener('click', function() {
            confirmModal.classList.add('hidden');
            donateForm.classList.add('hidden');
            successMessage.classList.remove('hidden');
            // Show share bar with slide-down animation
            var shareBar = document.getElementById('shareBar');
            if (shareBar) {
                shareBar.style.display = 'flex';
                setTimeout(function() {
                    shareBar.classList.add('visible');
                }, 80);
            }
        });
        confirmNoBtn.addEventListener('click', function() {
            confirmModal.classList.add('hidden');
            // Return focus to donate button for accessibility
            donateForm.querySelector('button[type="submit"]').focus();
        });
        // Hide modal when clicking outside
        confirmModal.addEventListener('click', function(e) {
            if (e.target === confirmModal) {
                confirmModal.classList.add('hidden');
                donateForm.querySelector('button[type="submit"]').focus();
            }
        });
        // Trap focus inside modal for accessibility
        confirmModal.addEventListener('keydown', function(e) {
            if (!confirmModal.classList.contains('hidden')) {
                const focusable = confirmModal.querySelectorAll('button');
                if (e.key === 'Tab') {
                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];
                    if (e.shiftKey) {
                        if (document.activeElement === first) {
                            last.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === last) {
                            first.focus();
                            e.preventDefault();
                        }
                    }
                }
                if (e.key === 'Escape') {
                    confirmModal.classList.add('hidden');
                    donateForm.querySelector('button[type="submit"]').focus();
                }
            }
        });
    </script>
</body>
</html>
